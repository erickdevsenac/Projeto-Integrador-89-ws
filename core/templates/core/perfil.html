{% extends 'global/base.html' %}
{% load static %}



{% block content %}
{% block head %}
<title>Meu Perfil - {{ user.username }}</title>
<link rel="stylesheet" href="{% static 'core/css/style_perfil.css' %}">
{% endblock head %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-body text-center">
                  {% if perfil.foto_perfil %}
                      <img src="{{ perfil.foto_perfil.url }}" alt="Foto do Perfil" class="rounded-circle img-fluid" style="width: 150px; height: 150px; object-fit: cover;">
                  {% else %}
                      <img src="{% static 'assets/img/placeholder_user.png' %}" alt="Foto do Perfil" class="rounded-circle img-fluid" style="width: 150px; height: 150px; object-fit: cover;">
                  {% endif %}                    
                  <h5 class="my-3">{{ perfil.nome_completo|default:perfil.nome_negocio|default:user.username }}</h5>
                    <p class="text-muted mb-1">{{ perfil.get_tipo_display }}</p>
                    <p class="text-muted mb-4">{{ perfil.endereco|default:"Endere√ßo n√£o informado" }}</p>
                    <div class="d-flex justify-content-center mb-2">
                        <button type="button" class="btn btn-primary" id="edit-profile-btn">Editar Perfil</button>
                        <a href="{% url 'core:logout' %}" class="btn btn-outline-danger ms-1">Sair</a>
                    </div>
                </div>
            </div>
            <div class="card">
                 <div class="card-body">
                    <h5 class="card-title">A√ß√µes R√°pidas</h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><a href="{% url 'core:meus_pedidos' %}">üì¶ Meus Pedidos</a></li>
                        <li class="list-group-item"><a href="{% url 'core:configuracoes' %}">‚öôÔ∏è Configura√ß√µes</a></li>
                        <li class="list-group-item"><a href="{% url 'core:alterar_senha' %}">üîë Alterar Senha</a></li>
                    </ul>
                 </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div id="view-mode">
                {% if perfil.tipo == 'VENDEDOR' %}
                    <h4 class="mb-4">Dashboard do Vendedor</h4>
                    <div class="card mb-4">
                        <div class="card-header">Produtos com Baixo Estoque</div>
                        <div class="card-body">
                            {% for produto in dashboard.baixo_estoque %}
                                <p>{{ produto.nome }} - <strong>Restam apenas {{ produto.quantidade_estoque }} unidades.</strong></p>
                            {% empty %}
                                <p class="text-muted">Nenhum produto com baixo estoque.</p>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                <div class="card">
                    <div class="card-header">√öltimos Pedidos</div>
                    <div class="card-body">
                         {% for pedido in dashboard.ultimos_pedidos %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Pedido #{{ pedido.numero_pedido|default:pedido.pedido_principal.numero_pedido }}</span>
                                <span class="badge bg-info">{{ pedido.get_status_display|default:pedido.get_status_pagamento_display }}</span>
                                <span>R$ {{ pedido.valor_total|default:pedido.valor_subtotal|floatformat:2 }}</span>
                            </div>
                         {% empty %}
                            <p class="text-muted">Nenhum pedido recente.</p>
                         {% endfor %}
                    </div>
                </div>
            </div>

            <div class="mt-5">
                <h2>Avalia√ß√µes Recebidas</h2>
                <div id="avaliacoes-perfil">
                    <!-- As avalia√ß√µes ser√£o carregadas aqui via JavaScript ou renderizadas pelo backend -->
                    <p>Nenhuma avalia√ß√£o ainda. Seja o primeiro a avaliar!</p>
                </div>
                {% if user.is_authenticated and user.perfil != perfil %}
                <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#modalAvaliacaoPerfil">Deixar uma Avalia√ß√£o</button>
                {% elif not user.is_authenticated %}
                <p class="mt-3">Fa√ßa <a href="{% url 'core:telalogin' %}">login</a> para deixar uma avalia√ß√£o.</p>
                {% endif %}
            </div>

            <div id="edit-mode" style="display: none;">
                <div class="card">
                    <div class="card-body">
                        <h4 class="mb-4">Editar Informa√ß√µes do Perfil</h4>
                        <form method="POST" enctype="multipart/form-data">
                            {% csrf_token %}
                            {{ form.as_p }}
                            <hr>
                            <button type="submit" class="btn btn-success">Salvar Altera√ß√µes</button>
                            <button type="button" class="btn btn-secondary" id="cancel-edit-btn">Cancelar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const viewMode = document.getElementById('view-mode');
        const editMode = document.getElementById('edit-mode');
        const editButton = document.getElementById('edit-profile-btn');
        const cancelButton = document.getElementById('cancel-edit-btn');

        editButton.addEventListener('click', () => {
            viewMode.style.display = 'none';
            editMode.style.display = 'block';
        });

        cancelButton.addEventListener('click', () => {
            editMode.style.display = 'none';
            viewMode.style.display = 'block';
        });
    });
</script>
{% include 'parciais/_avaliacao_modal_perfil.html' %}
{% endblock %}