{% extends 'global/base.html' %}
{% load static %}

{% block content %}
{% block head %}
<title>Meu Perfil - {{ user.username }}</title>
<link rel="stylesheet" href="{% static 'core/css/style_perfil.css' %}">
{% endblock head %}

<div class="container my-5">
    <div class="row">

        <div class="col-lg-4">

            <div class="card mb-4">
                <div class="card-body text-center">
                    {% if perfil and perfil.foto_perfil %}
                        <img src="{{ perfil.foto_perfil.url }}" alt="Foto do Perfil"
                             class="rounded-circle img-fluid"
                             style="width: 150px; height: 150px; object-fit: cover;">
                    {% else %}
                        <img src="{% static 'assets/img/placeholder_user.png' %}" alt="Foto do Perfil"
                             class="rounded-circle img-fluid"
                             style="width: 150px; height: 150px; object-fit: cover;">
                    {% endif %}

                    <h5 class="my-3">
                        {{ perfil.nome_completo|default:perfil.nome_negocio|default:user.username }}
                    </h5>

                    <p class="text-muted mb-1">{{ perfil.get_tipo_display }}</p>
                    <p class="text-muted mb-4">{{ perfil.endereco|default:"Endere√ßo n√£o informado" }}</p>

                    <div class="d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-primary" id="edit-profile-btn">Editar Perfil</button>
                        <a href="{% url 'core:logout' %}" class="btn btn-outline-danger">Sair</a>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">A√ß√µes R√°pidas</h5>
                    <ul class="list-group list-group-flush">
                        {% if perfil.tipo == 'VENDEDOR' %}
                            <li class="list-group-item">
                                <a href="{% url 'core:painel_pedidos_vendedor' %}">
                                    üìä Painel de Pedidos
                                </a>
                            </li>
                            {% else %}
                            <li class="list-group-item">
                                <a href="{% url 'core:meus_pedidos' %}">
                                    üì¶ Meus Pedidos
                                </a>
                            </li>
                            {% endif %}
                        <li class="list-group-item"><a href="{% url 'core:configuracoes' %}">‚öôÔ∏è Configura√ß√µes</a></li>
                        <li class="list-group-item"><a href="{% url 'core:alterar_senha' %}">üîë Alterar Senha</a></li>
                    </ul>
                </div>
            </div>

        </div>

        <div class="col-lg-8">

            <div id="view-mode">

                {% if perfil %}
                    {% if perfil.tipo == 'VENDEDOR' %}

                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-light text-dark">Produtos com Baixo Estoque</div>
                            <div class="card-body">
                                {% if dashboard.baixo_estoque %}
                                    <ul class="list-group list-group-flush">
                                        {% for produto in dashboard.baixo_estoque %}
                                            <li class="list-group-item">
                                                {{ produto.nome }} - <strong>{{ produto.quantidade_estoque }} unidades restantes</strong>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-muted mb-0">Nenhum produto com baixo estoque.</p>
                                {% endif %}
                            </div>
                        </div>

                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-light text-dark">√öltimos Pedidos de Clientes</div>
                            <div class="card-body">
                                {% if dashboard.ultimos_pedidos %}
                                    {% for pedido in dashboard.ultimos_pedidos %}
                                        <div class="mb-3 p-3 border rounded bg-white">
                                            <strong>Pedido #{{ pedido.numero_pedido }}</strong> | <strong>Cliente:</strong> {{ pedido.cliente }} | <strong>Data: </strong> {{ pedido.data_criacao|date:"d/m/Y H:i" }}
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">Nenhum pedido recente de clientes.</p>
                                {% endif %}
                            </div>
                        </div>

                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-light text-dark">Avalia√ß√µes Recebidas</div>
                            <div class="card-body">
                                <p>M√©dia: <strong>{{ media_avaliacoes|floatformat:1 }}</strong> / 5 ({{ total_avaliacoes }} avalia√ß√µes)</p>
                                {% if avaliacoes_produtos %}
                                    <div class="row g-3">
                                        {% for avaliacao in avaliacoes_produtos %}
                                            <div class="col-12">
                                                <div class="card border-light shadow-sm">
                                                    <div class="card-body">
                                                        <h6 class="mb-1">{{ avaliacao.autor.username }}</h6>
                                                        <p class="mb-1 text-muted">{{ avaliacao.texto|default:"Sem coment√°rio" }}</p>
                                                        {% if avaliacao.produto %}
                                                            <p class="mb-1"><strong>Produto:</strong> {{ avaliacao.produto.nome }}</p>
                                                        {% endif %}
                                                        <p class="mb-0 text-warning">
                                                            {% for i in "12345" %}
                                                                {% if forloop.counter <= avaliacao.nota %}
                                                                    &#9733;
                                                                {% else %}
                                                                    &#9734;
                                                                {% endif %}
                                                            {% endfor %}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p class="text-muted">Nenhuma avalia√ß√£o de produto ainda.</p>
                                {% endif %}
                            </div>
                        </div>

                    {% elif perfil.tipo == 'CLIENTE' or perfil.tipo == 'ONG' %}

                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-light text-dark">√öltimos Pedidos</div>
                            <div class="card-body">
                                {% if dashboard.ultimos_pedidos %}
                                    <ul class="list-group list-group-flush">
                                        {% for pedido in dashboard.ultimos_pedidos %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    Pedido #{{ pedido.numero_pedido }}
                                                    <span class="badge bg-secondary">
                                                        {{ pedido.get_status_pagamento_display }}
                                                    </span>
                                                </div>
                                                <span>R$ {{ pedido.valor_total|floatformat:2 }}</span>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-muted mb-0">Nenhum pedido recente.</p>
                                {% endif %}
                            </div>
                        </div>

                    {% endif %}
                {% endif %}

            </div>

            <div id="edit-mode" style="display: none;">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h4 class="mb-4">Editar Informa√ß√µes do Perfil</h4>
                        <form method="POST" enctype="multipart/form-data">
                            {% csrf_token %}
                            <input type="hidden" name="editar_perfil" value="1">
                            {{ form.as_p }}
                            <hr>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-success">Salvar Altera√ß√µes</button>
                                <button type="button" class="btn btn-secondary" id="cancel-edit-btn">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </div>

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const viewMode = document.getElementById('view-mode');
    const editMode = document.getElementById('edit-mode');
    const editButton = document.getElementById('edit-profile-btn');
    const cancelButton = document.getElementById('cancel-edit-btn');

    editButton?.addEventListener('click', () => {
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
    });

    cancelButton?.addEventListener('click', () => {
        editMode.style.display = 'none';
        viewMode.style.display = 'block';
    });
});
</script>

{% include 'parciais/_avaliacao_modal_perfil.html' %}
{% endblock %}
