{% extends 'global/base.html' %}
{% load static %}

{% block head %}
<title>Finalizar Compra - Aproveite+</title>
<link rel="stylesheet" href="{% static 'core/css/style_checkout.css' %}">
{% endblock %}

{% block content %}
<div class="checkout-container">
  <div class="container">
    <h2 class="fw-bold mb-5 text-dark">Finalizar Compra</h2>

    <div class="row g-5">
      {# RESUMO CARRINHO #}
      <div class="col-md-5 col-lg-4 order-md-last">
        <div class="card card-resumo p-3">
          <h4 class="d-flex justify-content-between align-items-center mb-4 px-2">
            <span class="text-secondary">Seu Carrinho</span>
            <span class="badge rounded-pill badge-carrinho">{{ carrinho|length }}</span>
          </h4>

          <ul class="list-group list-group-flush mb-3">
            {% for item in carrinho %}
            <li class="list-group-item d-flex justify-content-between lh-sm">
              <div>
                <h6 class="my-0 fw-bold">{{ item.nome }}</h6>
                <small class="text-muted">Quantidade: {{ item.quantidade }}</small>
              </div>
              <span class="fw-semibold text-dark">R$ {{ item.preco|floatformat:2 }}</span>
            </li>
            {% endfor %}

            {% if valor_desconto %}
            <li class="list-group-item d-flex justify-content-between bg-light">
              <div class="text-success">
                <h6 class="my-0">Cupom aplicado</h6>
                <small>{{ cupom.codigo }}</small>
              </div>
              <span class="text-success">− R$ {{ valor_desconto|floatformat:2 }}</span>
            </li>
            {% endif %}

            <li class="list-group-item d-flex justify-content-between pt-3">
              <span class="fs-5 fw-bold total-label">Total</span>
              <strong class="fs-5 total-valor">
                R$ {{ total_final|default:total_carrinho|floatformat:2 }}
              </strong>
            </li>
          </ul>

          <form method="post" action="{% url 'core:aplicar_cupom' %}" class="p-2">
            {% csrf_token %}
            <h6 class="text cupom-label">Aplicar cupom:</h6>
            <div class="input-group">
              <input type="text" name="codigo" class="form-control form-control-sm" placeholder="Ex: 2025-aproveite">
              <button class="btn btn-dark" type="submit">Aplicar</button>
            </div>
          </form>
        </div>
      </div>

      {# CHECKOUT #}
      <div class="col-md-7 col-lg-8">
        <div class="card p-4 shadow-sm border-0 card-checkout">
          <form method="post" action="{% url 'core:finalizar_pedido' %}" novalidate>
            {% csrf_token %}

            {# ERROS GLOBAIS #}
            {% if form.non_field_errors %}
              <div class="alert alert-danger">{{ form.non_field_errors }}</div>
            {% endif %}

            <h4 class="mb-3 border-bottom pb-2">Endereço de Entrega</h4>

            {# RESUMO DO PERFIL #}
            <div id="checkout-address-summary" class="checkout-address-summary">
              <div class="address-text">
                <p class="mb-1 fw-semibold">
                  {{ usuario }}
                </p>
                <p class="mb-1 text-muted">
                  {{ usuario.endereco_completo|default:usuario.endereco|default:"Endereço não informado" }}
                </p>
                {% if usuario.telefone %}
                <p class="mb-0 text-muted">
                  Tel: {{ usuario.telefone }}
                </p>
                {% endif %}
              </div>

              <button
                type="button"
                class="btn btn-outline-success btn-sm ms-lg-3 mt-3 mt-lg-0"
                id="btn-toggle-endereco"
                data-mode="resumo"
              >
                Editar endereço
              </button>
            </div>

            <div id="checkout-address-fields" class="mt-3 d-none">
                <h5 class="fw-semibold mb-3">Endereço de entrega</h5>
                
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">CEP</label>
                        {{ form.cep }}
                    </div>
                    <div class="col-md-8">
                        <label class="form-label fw-semibold">Rua</label>
                        {{ form.rua }}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Número</label>
                        {{ form.numero }}
                    </div>
                    <div class="col-md-8">
                        <label class="form-label fw-semibold">Bairro</label>
                        {{ form.bairro }}
                    </div>

                    <div class="col-md-8">
                        <label class="form-label fw-semibold">Cidade</label>
                        {{ form.cidade }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Estado</label>
                        {{ form.estado }}
                    </div>
                </div>
                
                {% if form.cep.errors or form.rua.errors %}
                    <div class="alert alert-danger mt-2">Por favor, preencha todos os campos do endereço.</div>
                {% endif %}
            </div>

            <h4 class="mb-4 mt-5 border-bottom pb-2">Pagamento</h4>
            <div class="payment-options">
              {{ form.forma_pagamento }}
              {% if form.forma_pagamento.errors %}
                <div class="invalid-feedback d-block mt-2">
                  {{ form.forma_pagamento.errors|striptags }}
                </div>
              {% endif %}
            </div>

            <hr class="my-5">

            <div class="row align-items-center flex-column-reverse flex-lg-row">
              <div class="col-lg-8">
                <p class="text-muted small text-center text-lg-start mb-3 mb-lg-0">
                  Ao confirmar, você concorda com nossos termos de serviço e políticas de privacidade.
                </p>
              </div>
              <div class="col-lg-4">
                <button href="{% url 'core:meus_pedidos' %}"type="submit" class="btn btn-checkout w-100 btn-lg">
                  Finalizar Pedido
                </button>
              </div>
            </div>
          </form>
        </div>

        <div class="mt-3">
          <a href="{% url 'core:ver_carrinho' %}" class="text-decoration-none text-muted">
            <i class="bi bi-arrow-left"></i> Voltar para o carrinho
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const btn = document.getElementById('btn-toggle-endereco');
    const fields = document.getElementById('checkout-address-fields');

    if (!btn || !fields) return;

    btn.addEventListener('click', function () {
      const isEditing = !fields.classList.contains('d-none');

      if (isEditing) {
        fields.classList.add('d-none');
        btn.textContent = 'Editar endereço';
        btn.dataset.mode = 'resumo';
      } else {
        fields.classList.remove('d-none');
        btn.textContent = 'Usar endereço do cadastro';
        btn.dataset.mode = 'edicao';
      }
    });
  });
</script>
{% endblock content %}
