<div class="modal fade" id="modalAvaliacaoProduto" tabindex="-1" aria-labelledby="modalAvaliacaoProdutoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAvaliacaoProdutoLabel">Deixar sua Avaliação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formAvaliacao">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="nota" class="form-label">Nota (1-5 estrelas)</label>
                        <input type="number" class="form-control" id="nota" name="nota" min="1" max="5" required>
                    </div>
                    <div class="mb-3">
                        <label for="comentario" class="form-label">Comentário (opcional)</label>
                        <textarea class="form-control" id="comentario" name="texto" rows="3"></textarea>
                    </div>
                    <input type="hidden" id="content_type_id" name="content_type">
                    <input type="hidden" id="object_id" name="object_id">
                    <button type="submit" class="btn btn-primary">Enviar Avaliação</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const formAvaliacao = document.getElementById("formAvaliacao");
        const modalAvaliacaoProduto = document.getElementById("modalAvaliacaoProduto");

        if (formAvaliacao) {
            // Preencher content_type_id e object_id quando o modal é aberto
            modalAvaliacaoProduto.addEventListener("show.bs.modal", function (event) {
                const button = event.relatedTarget; // Botão que acionou o modal
                const contentType = button.getAttribute("data-content-type");
                const objectId = button.getAttribute("data-object-id");

                document.getElementById("content_type_id").value = contentType;
                document.getElementById("object_id").value = objectId;
            });

            formAvaliacao.addEventListener("submit", function(event) {
                event.preventDefault();

                const formData = new FormData(formAvaliacao);
                const data = {
                    nota: parseInt(formData.get("nota")),
                    texto: formData.get("texto"),
                    content_type: parseInt(formData.get("content_type")),
                    object_id: parseInt(formData.get("object_id")),
                };

                fetch("/api/avaliacoes/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
                        // Adicionar token JWT se o usuário estiver logado
                        // "Authorization": "Bearer " + localStorage.getItem("access_token"),
                    },
                    body: JSON.stringify(data),
                })
                .then(response => response.json())
                .then(result => {
                    if (result.id) {
                        alert("Avaliação enviada com sucesso!");
                        // Fechar modal e recarregar avaliações
                        const modal = bootstrap.Modal.getInstance(modalAvaliacaoProduto);
                        modal.hide();
                        // TODO: Recarregar a seção de avaliações ou adicionar a nova avaliação dinamicamente
                    } else {
                        alert("Erro ao enviar avaliação: " + JSON.stringify(result));
                    }
                })
                .catch(error => {
                    console.error("Erro:", error);
                    alert("Erro ao enviar avaliação.");
                });
            });
        }
    });
</script>